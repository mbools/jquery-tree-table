/*! js-tree-table 2016-02-23 */
"use strict";!function(a){var b={SORT_ORDER:"asc",SORT_TYPE:"alpha",OPENGLYPH:"jtt-open",CLOSEDGLYPH:"jtt-closed",INDENT:15};a(document).ready(function(){a("table.treetable").treetable()}),a.widget("mbools.treetable",{options:{active:!1,insertOrder:!1,forceTreeConstraints:!1,showLines:!0,nodeOpenGlyph:b.OPENGLYPH,nodeClosedGlyph:b.CLOSEDGLYPH,indent:b.INDENT},_columnSettings:[],_create:function(){this.element.hasClass("treetable")||this.element.addClass("treetable"),this._update()},_setOption:function(a,b){this.options[a]=b,this.element.data[a]!==b&&(this.element.data[a]=b)},_update:function(){this._updateOptions(),this._updateColSettings(),this._buildTree(),this._sort(),this._reflowTable(),this._redecorate()},_shiftErrorsToEnd:function(){var b=a(".jtt-error");b.remove().appendTo(this.element)},_updateOptions:function(){this.options.active=this.options.active||this.element.attr("data-jtt-active"),this.options.insertOrder=this.options.insertOrder||this.element.attr("data-jtt-insert-order"),this.options.forceTreeConstraints=this.options.forceTreeConstraints||this.element.attr("data-jtt-force-tree-constraints")},_updateColSettings:function(){var b=this;a(b.element.find("thead tr").get().reverse()).each(function(c,d){var e=a(d),f=1;e.find("th,td").each(function(d,e){for(var g=a(e),h=+g.attr("colspan")||1,i={tree:g.data("jtt-tree"),sort:g.data("jtt-sort"),sortOrder:g.data("jtt-sort-order"),sortType:g.data("jtt-sort-type")},j=0;h>j;j++)if(0===c)b._columnSettings[f+j]=i;else for(var k in i)void 0===b._columnSettings[f+j][k]&&(b._columnSettings[f+j][k]=i[k]);f+=h})}),console.log(this._columnSettings)},_treeColumn:function(){return this._columnSettings.findIndex(function(a){return a&&void 0!==a.tree})+1},_fixupParents:function(){this.element.find("tbody tr[data-jtt-fixed-parent]").attr("data-jtt-parent",function(){return this.getAttribute("data-jtt-fixed-parent")})},_buildTree:function(){var b=this,c={"/":{id:"/",children:[]}};this._fixupParents(),this._tree={},b.element.find("tbody tr").each(function(d,e){var f=a(e),g=f.data("jtt-id");if(g&&c[g])console.log("jquery-tree-table: Duplicate jtt-id ("+g+") in table at row "+d+". Ignored."),f.addClass("jtt-error");else{var h=f.data("jtt-fixed-parent")||f.data("jtt-parent");if(!h){var i=f.prevAll("[data-jtt-parent]").last();h=i.length?i.data("jtt-parent"):"/"}h===g&&(console.log("jQuery-tree-table: "+g+" defined with itself as parent. Ignored, setting parent to root"),h="/"),g||(g=b._guid(),f.attr("data-jtt-id",g)),c[g]={id:g,parent:h,$row:f,children:[],open:!0}}}),b._tree=c["/"],delete c["/"];for(var d in c)"/"!==c[d].parent?c[c[d].parent].children.push(c[d]):b._tree.children.push(c[d])},_guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},_reflowTable:function(){var a=this;(this.options.forceTreeConstraints||this._treeColumn())&&(this._treeWalk(this._tree,function(b){a.element.find("tbody tr");b.$row.detach(),a.element.append(b.$row)}),this._shiftErrorsToEnd())},_treeWalk:function(a,b){var c=arguments.length<=2||void 0===arguments[2]?0:arguments[2],d=!0;if(a.$row&&(d=b(a,c),d=void 0!==d&&"boolean"==typeof d?d:!0),d)for(var e=a.children.length,f=0;e>f;f++)this._treeWalk(a.children[f],b,c+1)},_redecorate:function(){var b=this,c=this,d=this.options.indent,e=this._treeColumn();0!==e&&this._treeWalk(this._tree,function(f,g){var h=f.$row.find("td.jtt-tree-node");if(0===h.length){var i=a('<div class="jtt-node-offset" style="margin-left: '+g*d+'px"><div class="jtt-connector"></div></div>');h=f.$row.find("td:nth-of-type("+(e-1)+")").addClass("jtt-tree-node").wrapInner('<div class="jtt-entry"></div>').prepend(i);var j=a('<a link="#" class="jtt-control"><span></span></a>');f.children.length&&(j.on("click",function(b){var d=f;c._toggleNode(d),a(b.currentTarget).find("span").first().removeClass(f.open?c.options.nodeClosedGlyph:c.options.nodeOpenGlyph).addClass(f.open?c.options.nodeOpenGlyph:c.options.nodeClosedGlyph)}).find("span").first().addClass(f.open?c.options.nodeOpenGlyph:c.options.nodeClosedGlyph),i.append(j))}if(b.options.showLines&&f.parent&&"/"!==f.parent){var k=h.closest("tbody").find('tr[data-jtt-id="'+f.parent+'"] td:nth-of-type('+(e-1)+")").offset().top,l=h.offset().top-k-5;f.$row.find("div.jtt-connector").addClass("jtt-show-lines").css("height",l+"px").css("margin-top","-"+l+"px")}else f.$row.find("div.jtt-connector").removeClass("jtt-show-lines")})},_toggleNode:function(a){var b=a.children.length;a.open=!a.open;for(var c=0;b>c;c++)this._treeWalk(a.children[c],function(b){return b.open?void b.$row.toggle(a.open):!1});this._redecorate()},_sort:function(){}})}(jQuery);
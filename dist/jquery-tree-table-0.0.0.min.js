/*! jquery-tree-table 2016-03-08 */
"use strict";!function(a,b){var c={active:"data-jtt-active",insertOrder:"data-jtt-insert-order",forceTreeConstraints:"data-jtt-force-tree-constraints",indent:"data-jtt-indent",hideLines:"data-jtt-hide-lines",nodeOpenGlyph:"data-jtt-open-glyph",nodeClosedGlyph:"data-jtt-closed-glyph",sort:"data-jtt-sort",sortOrder:"data-jtt-sort-order",sortType:"data-jtt-sort-type",tree:"data-jtt-tree",id:"data-jtt-id",parent:"data-jtt-parent",fixedParent:"data-jtt-fixed-parent",limitParent:"data-jtt-limit-parent"},d={MARKER:"treetable"},e={SORT_ORDER:"asc",SORT_TYPE:"alpha",OPENGLYPH:"jtt-open",CLOSEDGLYPH:"jtt-closed",INDENT:15,ROOTPATH:"/",VALIDSORTORDER:{ASC:"asc",DESC:"desc"},VALIDSORTTYPE:{ALPHA:"alpa",NUM:"num"}},f=!0;a(document).ready(function(){a("table.treetable").treetable()}),a.widget("mbools.treetable",{options:{active:!1,insertOrder:!1,forceTreeConstraints:!1,hideLines:!1,nodeOpenGlyph:e.OPENGLYPH,nodeClosedGlyph:e.CLOSEDGLYPH,indent:e.INDENT,console:{errors:!1}},_columnSettings:[],_sortColumns:[],_observers:{},_create:function(){this.element.hasClass(d.MARKER)||this.element.addClass(d.MARKER),(void 0!==this.element.attr(c.active)||this.options.active)&&this._active(!0),this._update()},active:function(a){return void 0!==a&&this._active(a),this.options.active},forceTreeConstraints:function(a){return void 0!==a&&(this._forceTreeConstraints=a),this.options.forceTreeConstraints},hideLines:function(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return void 0!==a&&(this.options.hideLines=a,this.element.attr(c.hideLines)&&!a?this.element.removeAttr(c.hideLines):this.element.attr(c.hideLines,""),b&&!this.options.active&&this._redecorate()),this.options.hideLines},indent:function(a,b){this.options.indent=a,this.element.attr(c.indent,a),b&&!this.options.active&&this._redecorate()},nodeGlyphs:function(a,b,c){this.nodeOpenGlyph(a,!1),this.nodeClosedGlyph(b,!1),c&&!this.options.active&&this._redecorate()},nodeOpenGlyph:function(a,b){"string"==typeof a&&(this.options.nodeOpenGlyph=a,this.element.attr(c.nodeOpenGlyph,a),b&&!this.options.active&&this._redecorate())},nodeClosedGlyph:function(a,b){"string"==typeof a&&(this.options.nodeClosedGlyph=a,this.element.attr(c.nodeClosedGlyph,a),b&&!this.options.active&&this._redecorate())},redecorate:function(){this._redecorate()},update:function(){this._update()},_update:function(){this._bodyObserverState(!1),this._updateOptions(),this._updateColSettings(),this._buildTree(),this.options.forceTreeConstraints&&this._imposeTreeConstraints(),this._sort(),this._reflowTable(),this._redecorate(),this.options.active&&this._bodyObserverState(!0)},_updateOptions:function(){this.options.active=void 0!==this.element.attr(c.active)?!0:this.options.active,this.options.indent=+this.element.attr(c.indent)||this.options.indent,this.options.insertOrder=void 0!==this.element.attr(c.insertOrder)?!0:this.options.insertOrder,this.options.hideLines=void 0!==this.element.attr(c.hideLines)?!0:this.options.hideLines,this.options.forceTreeConstraints=void 0!==this.element.attr(c.forceTreeConstraints)?!0:this.options.forceTreeConstraints},_updateColSettings:function(){var b=this;a(b.element.find("thead tr").get().reverse()).each(function(d,e){var f=a(e),g=1;f.find("th,td").each(function(e,f){for(var h=a(f),i=+h.attr("colspan")||1,j={tree:h.attr(c.tree),sort:h.attr(c.sort),sortOrder:h.attr(c.sortOrder),sortType:h.attr(c.sortType)},k=0;i>k;k++)if(j.colIndex=g+k,0===d)b._columnSettings[g+k]=j;else for(var l in j)void 0===b._columnSettings[g+k][l]&&(b._columnSettings[g+k][l]=j[l]);void 0!==j.sort&&b._sortColumns.push(j),g+=i})}),f&&console.log("Current column settings: "+this._columnSettings),f&&console.log("Current column sort: "+this._sortColumns+"("+this._sortColumns.length+")")},_buildTree:function(){var b=this,d={};d[e.ROOTPATH]={id:e.ROOTPATH,children:[]},this._tree={},b.element.find("tbody tr").each(function(f,g){var h=a(g),i=h.attr(c.id);if(i||(i=b._uuid(),h.attr(c.id,i)),d[i])b.options.console.errors&&console.log("jquery-tree-table: Duplicate jtt-id ("+i+") in table at row "+f+". Ignored."),h.addClass("jtt-error");else{var j=h.attr(c.fixedParent)||h.attr(c.parent)||h.attr(c.limitParent);if(!j){var k=h.prevAll("["+c.parent+"]").first();j=k.length&&b.options.insertOrder?k.attr(c.parent):e.ROOTPATH}j===i&&(b.options.console.errors&&console.log("jQuery-tree-table: "+i+" defined with itself as parent. Ignored, setting parent to root"),j=e.ROOTPATH),h.attr(c.parent,j),d[i]={id:i,parent:j,$row:h,children:[],open:0===h.find(".jtt-closed").length}}}),b._tree=d[e.ROOTPATH],delete d[e.ROOTPATH];var f=b.options.forceTreeConstraints||0!==b._treeColumn();for(var g in d)f&&d[g].parent!==e.ROOTPATH?d[d[g].parent].children.push(d[g]):b._tree.children.push(d[g])},_imposeTreeConstraints:function(){var a=this,b=this;(b.options.forceTreeConstraints||b._treeColumn()>0)&&b._treeWalk(b._tree,function(b){var d=b.$row.attr(c.fixedParent);d&&(b.$row.removeAttr(c.limitParent),b.parent!=d&&(b.parent=d,b.$row.attr(c.parent,d)));var e=b.$row.attr(c.limitParent);if(void 0!==e){var f=a._findAncestors(b);-1===f.indexOf(e)&&(b.parent=e,b.$row.attr(c.parent,e))}})},_sort:function(){var a=this._sortColumns;if(void 0===a||0!==a.length){var b=a.length;if(0!==b){var c=function(a){return function(b,c){f&&console.log("Checking col("+a.colIndex+"): "+b.$row.find("td:nth-child(1)").text()+" AGAINST "+c.$row.find("td:nth-child(1)").text());var d=0,g=b.$row.find("td:nth-child("+a.colIndex+")").text(),h=c.$row.find("td:nth-child("+a.colIndex+")").text();return a.sortType===e.VALIDSORTTYPE.NUM&&(g=Number(g),h=Number(h)),d=a.sortOrder===e.VALIDSORTORDER.ASC?h>g?-1:g===h?0:1:g>h?-1:g===h?0:1}},d=function(a,b,d){var e=a.children.length,f=d[0];if(!(2>e||void 0===f)){var g="function"==typeof f.sortFn?f.sortFn:c(f);a.children.sort(g);for(var h=d.length,i=f.colIndex,j=1;h>j;j++)for(var k=0,l=!1,m=!1,n=1;e>n;n++)if(a.children[k].$row.find("td:nth-child("+i+")").text()===a.children[n].$row.find("td:nth-child("+i+")").text())l=!0,m=!0;else if(m&&(m=!1,k!=n)){var o=n-k;o>=2&&(g="function"==typeof f.sortFn?f.sortFn:c(d[j]),a.children.splice.apply(a.children,[k,0].concat(a.children.splice(k,o).sort(g))))}}};this._treeWalk(this._tree,d,0,a.slice(0))}}},_reflowTable:function(){var a=this;(this.options.forceTreeConstraints||this._treeColumn())&&(this._treeWalk(this._tree,function(b){b.$row.detach(),a.element.append(b.$row)}),this._shiftErrorsToEnd())},_redecorate:function(){var b=this,c=b.options.indent,d=b._treeColumn(),e=b._tree.children[0].$row.children("td.jtt-tree-node").index();if(f&&console.log("currentTNode is "+e+" treeCol (with offset) is "+(d-2)),e>=0&&e!==d-2){var g=b.element.find(".jtt-tree-node");g.find(".jtt-node-offset").remove(),g.find(".jtt-entry").contents().unwrap(),g.removeClass("jtt-tree-node")}0!==d&&b._treeWalk(b._tree,function(e,f){var g=e.$row.children("td.jtt-tree-node"),h=g.find("div.jtt-node-offset");if(0===g.length&&(h=a('<div class="jtt-node-offset" style="margin-left: '+f*c+'px"><div class="jtt-connector"></div></div>'),g=e.$row.children("td:nth-of-type("+(d-1)+")").addClass("jtt-tree-node").wrapInner('<div class="jtt-entry"></div>').prepend(h)),e.children.length){var i=h.find(".jtt-control");0===i.length&&(i=a('<a link="#" class="jtt-control"><span></span></a>'),i.on("click",function(c){var d=e;b._toggleNode(d),a(c.currentTarget).find("span").first().removeClass(e.open?b.options.nodeClosedGlyph:b.options.nodeOpenGlyph).addClass(e.open?b.options.nodeOpenGlyph:b.options.nodeClosedGlyph)}).find("span").first().addClass(e.open?b.options.nodeOpenGlyph:b.options.nodeClosedGlyph),h.append(i))}else e.$row.find("a.jtt-control").remove();if(!b.options.hideLines&&e.parent&&"/"!==e.parent){var j=!1,k=e.$row.prevAll('tr[data-jtt-parent="'+e.parent+'"]').first();0===k.length&&(k=e.$row.prev('tr[data-jtt-id="'+e.parent+'"]'),j=!0);var l=g.find("div.jtt-node-offset"),m=j?k.find(".jtt-control"):k.find("div.jtt-connector"),n=j?m.width()/2:0,o=m.offset().top+m.outerHeight(!1),p=m.offset().left+n,q=Math.ceil(l.offset().top+l.outerHeight()/2-o),r=l.offset().left-p-n;e.$row.find("div.jtt-connector").addClass("jtt-show-lines").css("height",q+"px").css("width",r+"px").offset({top:o,left:p+n})}else e.$row.find("div.jtt-connector").removeClass("jtt-show-lines")})},_toggleAttr:function(a,b){var c=b||!this.element.attr(a);c?this.element.attr(a,""):this.element.removeAttr(a)},_active:function(a){var b=this;this._toggleAttr(c.active,a),b.options.active=a,a?(void 0===b._observers.tbody&&(b._observers.tbody=new MutationObserver(function(a){b._update()})),void 0===b._observers.thead&&(b._observers.thead=new MutationObserver(function(a){b._update()})),b.element.find("thead td, thead th").each(function(){b._observers.thead.observe(this,{attributes:!0})}),b._bodyObserverState(!0)):(b._bodyObserverState(!1),void 0!==b._observers.thead&&b._observers.thead.disconnect())},_forceRedecorate:function(a){return a.preventDefault(),a.stopPropagation(),a.data._redecorate(),!1},_bodyObserverState:function(c){void 0!==this._observers.tbody&&(c?(this._observers.tbody.observe(this.element.find("tbody").get()[0],{childList:!0,subtree:!0,attributes:!0}),a(b).on("resize orientationchange",this,this._forceRedecorate),f&&console.log("OBSERVER ON")):(this._observers.tbody.disconnect(),a(b).off("resize orientationchange",this._forceRedecorate),f&&console.log("OBSERVER OFF")))},_shiftErrorsToEnd:function(){var b=a(".jtt-error");b.remove().appendTo(this.element)},_treeColumn:function(){return this._columnSettings.findIndex(function(a){return a&&void 0!==a.tree})+1},_fixupParents:function(){this.element.find("tbody tr["+c.fixedParent+"]").attr(c.parent,function(){return this.getAttribute(c.fixedParent)})},_findAncestors:function(a){for(var b=[],c=a;void 0!==c.parent;)b.push(c.parent),c=c.parent;return b},_uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},_treeWalk:function(a,b,c){var d=!0;c=+c||0;for(var e=arguments.length,f=Array(e>3?e-3:0),g=3;e>g;g++)f[g-3]=arguments[g];if(a.$row&&(d=b.apply(void 0,[a,c].concat(f)),d=void 0!==d&&"boolean"==typeof d?d:!0),d)for(var h=a.children.length,i=0;h>i;i++)this._treeWalk.apply(this,[a.children[i],b,c+1].concat(f))},_toggleNode:function(a){var b=a.children.length;a.open=!a.open;for(var c=function(b){return b.$row.toggle(a.open),b.open},d=0;b>d;d++)this._treeWalk(a.children[d],c);this._redecorate()}})}(jQuery,window);
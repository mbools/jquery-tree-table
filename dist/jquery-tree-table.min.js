/*! jquery-tree-table 2016-02-24 */
"use strict";!function(a){var b={active:"data-jtt-active",insertOrder:"data-jtt-insert-order",forceTreeConstraints:"data-jtt-force-tree-constraints",indent:"data-jtt-indent",showLines:"data-jtt-draw-lines",nodeOpenGlyph:"data-jtt-open-glyph",nodeClosedGlyph:"data-jtt-closed-glyph",sort:"data-jtt-sort",sortOrder:"data-jtt-sort-order",sortType:"data-jtt-sort-type",tree:"data-jtt-tree",id:"data-jtt-id",parent:"data-jtt-parent",fixedParent:"data-jtt-fixed-parent",limitParent:"data-jtt-limit-parent"},c={SORT_ORDER:"asc",SORT_TYPE:"alpha",OPENGLYPH:"jtt-open",CLOSEDGLYPH:"jtt-closed",INDENT:15};a(document).ready(function(){a("table.treetable").treetable()}),a.widget("mbools.treetable",{options:{active:!1,insertOrder:!1,forceTreeConstraints:!1,showLines:!0,nodeOpenGlyph:c.OPENGLYPH,nodeClosedGlyph:c.CLOSEDGLYPH,indent:c.INDENT,console:{errors:!1,debug:!0}},_columnSettings:[],_create:function(){this.element.hasClass("treetable")||this.element.addClass("treetable"),void 0!==this.element.attr(b.active)&&this._active(!0),this._update()},active:function(a){return void 0!==a&&this._active(a),this.options.active},forceTreeConstraints:function(a){return void 0!==a&&this._forceTreeConstraints(a),this.options.forceTreeConstraints=a},showLines:function(a,c){return void 0!==a&&(this.options.showLines=a,this.element.attr(b.showLines)&&!a?this.element.removeAttr(b.showLines):this.element.attr(b.showLines,""),c&&!this.options.active&&this._redecorate()),this.options.showLines},indent:function(a,c){this.options.indent=a,this.element.attr(b.indent,a),c&&!this.options.active&&this._redecorate()},nodeOpenGlyph:function(a,c){this.options.nodeOpenGlyph=a,this.element.attr(b.nodeOpenGlyph,a),c&&!this.options.active&&this._redecorate()},nodeClosedGlyph:function(a,c){this.options.nodeClosedGlyph=a,this.element.attr(b.nodeClosedGlyph,a),c&&!this.options.active&&this._redecorate()},redecorate:function(){this._redecorate()},update:function(){this._update()},_toggleAttr:function(a,b){var c=b||!this.element.attr(a);c?this.element.attr(a,""):this.element.removeAttr(a)},_active:function(a){var b=this;this._observers=this._observers||{},a?(void 0===b._observers.tbody&&(b._observers.tbody=new MutationObserver(function(a){b._update()})),void 0===b._observers.thead&&(b._observers.thead=new MutationObserver(function(a){b._update()})),b.element.find("thead td, thead th").each(function(){b._observers.thead.observe(this,{attributes:!0})}),b._bodyObserver(!0)):(b._bodyObserver(!1),void 0!==b._observers.thead&&b._observers.thead.disconnect()),b.options.active=a},_bodyObserver:function(a){if(a){var b=this._observers.tbody.observe(this.element.find("tbody").get()[0],{childList:!0,subtree:!0,attributes:!0});console.log("OBSERVER ON: "+b)}else void 0!==this._observers.tbody&&(this._observers.tbody.disconnect(),console.log("OBSERVER OFF"))},_setOption:function(a,b){this.options[a]=b,this.element.data[a]!==b&&(this.element.data[a]=b)},_update:function(){this._bodyObserver(!1),this._updateOptions(),this._updateColSettings(),this._buildTree(),this._sort(),this._reflowTable(),this._redecorate(),this.options.active&&this._bodyObserver(!0)},_shiftErrorsToEnd:function(){var b=a(".jtt-error");b.remove().appendTo(this.element)},_updateOptions:function(){this.options.active=this.options.active||this.element.attr(b.active),this.options.indent=this.options.indent||this.element.attr(b.indent),this.options.insertOrder=this.options.insertOrder||this.element.attr(b.insertOrder),this.options.forceTreeConstraints=this.options.forceTreeConstraints||this.element.attr(b.forceTreeConstraints)},_updateColSettings:function(){var c=this;a(c.element.find("thead tr").get().reverse()).each(function(d,e){var f=a(e),g=1;f.find("th,td").each(function(e,f){for(var h=a(f),i=+h.attr("colspan")||1,j={tree:h.attr(b.tree),sort:h.attr(b.sort),sortOrder:h.attr(b.sortOrder),sortType:h.attr(b.sortType)},k=0;i>k;k++)if(0===d)c._columnSettings[g+k]=j;else for(var l in j)void 0===c._columnSettings[g+k][l]&&(c._columnSettings[g+k][l]=j[l]);g+=i})}),console.log(this._columnSettings)},_treeColumn:function(){return this._columnSettings.findIndex(function(a){return a&&void 0!==a.tree})+1},_fixupParents:function(){this.element.find("tbody tr[data-jtt-fixed-parent]").attr("data-jtt-parent",function(){return this.getAttribute("data-jtt-fixed-parent")})},_buildTree:function(){var c=this,d={"/":{id:"/",children:[]}};this._fixupParents(),this._tree={},c.element.find("tbody tr").each(function(e,f){var g=a(f),h=g.data("jtt-id");if(h&&d[h])c.options.console.errors&&console.log("jquery-tree-table: Duplicate jtt-id ("+h+") in table at row "+e+". Ignored."),g.addClass("jtt-error");else{var i=g.attr(b.fixedParent)||g.attr(b.parent);if(!i){var j=g.prevAll("["+b.parent+"]").last();i=j.length?j.attr(b.parent):"/"}i===h&&(c.options.console.errors&&console.log("jQuery-tree-table: "+h+" defined with itself as parent. Ignored, setting parent to root"),i="/"),h||(h=c._guid(),g.attr(b.id,h)),d[h]={id:h,parent:i,$row:g,children:[],open:!0}}}),c._tree=d["/"],delete d["/"];for(var e in d)"/"!==d[e].parent?d[d[e].parent].children.push(d[e]):c._tree.children.push(d[e])},_guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},_reflowTable:function(){var a=this;(this.options.forceTreeConstraints||this._treeColumn())&&(this._treeWalk(this._tree,function(b){b.$row.detach(),a.element.append(b.$row)}),this._shiftErrorsToEnd())},_treeWalk:function(a,b){var c=arguments.length<=2||void 0===arguments[2]?0:arguments[2],d=!0;if(a.$row&&(d=b(a,c),d=void 0!==d&&"boolean"==typeof d?d:!0),d)for(var e=a.children.length,f=0;e>f;f++)this._treeWalk(a.children[f],b,c+1)},_redecorate:function(){var b=this,c=this,d=this.options.indent,e=this._treeColumn(),f=this._tree.children[0].$row.children("td.jtt-tree-node").index();if(c.options.console.debug&&console.log("currentTNode is "+f+" treeCol (with offset) is "+(e-2)),f>=0&&f!==e-2){var g=this.element.find(".jtt-tree-node");g.find(".jtt-node-offset").remove(),g.find(".jtt-entry").contents().unwrap(),g.removeClass("jtt-tree-node")}0!==e&&this._treeWalk(this._tree,function(f,g){var h=f.$row.children("td.jtt-tree-node");if(0===h.length){var i=a('<div class="jtt-node-offset" style="margin-left: '+g*d+'px"><div class="jtt-connector"></div></div>');h=f.$row.children("td:nth-of-type("+(e-1)+")").addClass("jtt-tree-node").wrapInner('<div class="jtt-entry"></div>').prepend(i);var j=a('<a link="#" class="jtt-control"><span></span></a>');f.children.length&&(j.on("click",function(b){var d=f;c._toggleNode(d),a(b.currentTarget).find("span").first().removeClass(f.open?c.options.nodeClosedGlyph:c.options.nodeOpenGlyph).addClass(f.open?c.options.nodeOpenGlyph:c.options.nodeClosedGlyph)}).find("span").first().addClass(f.open?c.options.nodeOpenGlyph:c.options.nodeClosedGlyph),i.append(j))}else h=f.$row.find("div.jtt-node-offset").css("margin-left",g*d+"px"),f.children.length||f.$row.find("a.jtt-control").remove();if(b.options.showLines&&f.parent&&"/"!==f.parent){var k=h.closest("tbody").find('tr[data-jtt-id="'+f.parent+'"] td:nth-of-type('+(e-1)+")").offset().top,l=h.offset().top-k-5;f.$row.find("div.jtt-connector").addClass("jtt-show-lines").css("height",l+"px").css("margin-top","-"+l+"px")}else f.$row.find("div.jtt-connector").removeClass("jtt-show-lines")})},_toggleNode:function(a){var b=a.children.length;a.open=!a.open;for(var c=0;b>c;c++)this._treeWalk(a.children[c],function(b){return b.open?void b.$row.toggle(a.open):!1});this._redecorate()},_sort:function(){}})}(jQuery);
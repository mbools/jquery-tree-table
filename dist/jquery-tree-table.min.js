/*! jquery-tree-table 2016-02-26 */
"use strict";!function(a){var b={active:"data-jtt-active",insertOrder:"data-jtt-insert-order",forceTreeConstraints:"data-jtt-force-tree-constraints",indent:"data-jtt-indent",showLines:"data-jtt-draw-lines",nodeOpenGlyph:"data-jtt-open-glyph",nodeClosedGlyph:"data-jtt-closed-glyph",sort:"data-jtt-sort",sortOrder:"data-jtt-sort-order",sortType:"data-jtt-sort-type",tree:"data-jtt-tree",id:"data-jtt-id",parent:"data-jtt-parent",fixedParent:"data-jtt-fixed-parent",limitParent:"data-jtt-limit-parent"},c={MARKER:"treetable"},d={SORT_ORDER:"asc",SORT_TYPE:"alpha",OPENGLYPH:"jtt-open",CLOSEDGLYPH:"jtt-closed",INDENT:15,ROOTPATH:"/",INSERTORDER:{ASC:"asc",DESC:"desc"}};a(document).ready(function(){a("table.treetable").treetable()}),a.widget("mbools.treetable",{options:{active:!1,insertOrder:!1,forceTreeConstraints:!1,showLines:!0,nodeOpenGlyph:d.OPENGLYPH,nodeClosedGlyph:d.CLOSEDGLYPH,indent:d.INDENT,console:{errors:!1,debug:!0}},_columnSettings:[],_observers:{},_create:function(){this.element.hasClass(c.MARKER)||this.element.addClass(c.MARKER),(void 0!==this.element.attr(b.active)||this.options.active)&&this._active(!0),this._update()},active:function(a){return void 0!==a&&this._active(a),this.options.active},forceTreeConstraints:function(a){return void 0!==a&&(this._forceTreeConstraints=a),this.options.forceTreeConstraints},showLines:function(a){var c=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return void 0!==a&&(this.options.showLines=a,this.element.attr(b.showLines)&&!a?this.element.removeAttr(b.showLines):this.element.attr(b.showLines,""),c&&!this.options.active&&this._redecorate()),this.options.showLines},indent:function(a,c){this.options.indent=a,this.element.attr(b.indent,a),c&&!this.options.active&&this._redecorate()},nodeOpenGlyph:function(a,c){"string"==typeof a&&(this.options.nodeOpenGlyph=a,this.element.attr(b.nodeOpenGlyph,a),c&&!this.options.active&&this._redecorate())},nodeClosedGlyph:function(a,c){"string"==typeof a&&(this.options.nodeClosedGlyph=a,this.element.attr(b.nodeClosedGlyph,a),c&&!this.options.active&&this._redecorate())},redecorate:function(){this._redecorate()},update:function(){this._update()},_update:function(){this._bodyObserverState(!1),this._updateOptions(),this._updateColSettings(),this._buildTree(),this._imposeTreeConstraints(),this._sort(),this._reflowTable(),this._redecorate(),this.options.active&&this._bodyObserverState(!0)},_updateOptions:function(){this.options.active=void 0!==this.element.attr(b.active)?!0:this.options.active,this.options.indent=+this.element.attr(b.indent)||this.options.indent;var a=this.element.attr(b.insertOrder);(d.INSERTORDER.ASC===a||d.INSERTORDER.DESC===a)&&(this.options.insertOrder=a),this.options.forceTreeConstraints=void 0!==this.element.attr(b.forceTreeConstraints)?!0:this.options.forceTreeConstraints},_updateColSettings:function(){var c=this;a(c.element.find("thead tr").get().reverse()).each(function(d,e){var f=a(e),g=1;f.find("th,td").each(function(e,f){for(var h=a(f),i=+h.attr("colspan")||1,j={tree:h.attr(b.tree),sort:h.attr(b.sort),sortOrder:h.attr(b.sortOrder),sortType:h.attr(b.sortType)},k=0;i>k;k++)if(0===d)c._columnSettings[g+k]=j;else for(var l in j)void 0===c._columnSettings[g+k][l]&&(c._columnSettings[g+k][l]=j[l]);g+=i})}),this.options.console.debug&&console.log("Current column settings: "+this._columnSettings)},_buildTree:function(){var c=this,e={};e[d.ROOTPATH]={id:d.ROOTPATH,children:[]},this._tree={},c.element.find("tbody tr").each(function(f,g){var h=a(g),i=h.attr(b.id);if(i||(i=c._uuid(),h.attr(b.id,i)),e[i])c.options.console.errors&&console.log("jquery-tree-table: Duplicate jtt-id ("+i+") in table at row "+f+". Ignored."),h.addClass("jtt-error");else{var j=h.attr(b.fixedParent)||h.attr(b.parent)||h.attr(b.limitParent);if(!j){var k=h.prevAll("["+b.parent+"]").last();j=k.length?k.attr(b.parent):d.ROOTPATH}j===i&&(c.options.console.errors&&console.log("jQuery-tree-table: "+i+" defined with itself as parent. Ignored, setting parent to root"),j=d.ROOTPATH),h.attr(b.parent,j),e[i]={id:i,parent:j,$row:h,children:[],open:!0}}}),c._tree=e[d.ROOTPATH],delete e[d.ROOTPATH];for(var f in e)e[f].parent!==d.ROOTPATH?e[e[f].parent].children.push(e[f]):c._tree.children.push(e[f])},_imposeTreeConstraints:function(){var a=this,c=this;c._treeWalk(c._tree,function(c){var d=c.$row.attr(b.fixedParent);d&&(c.$row.removeAttr(b.limitParent),c.parent!=d&&(c.parent=d,c.$row.attr(b.parent,d)));var e=c.$row.attr(b.limitParent);if(void 0!==e){var f=a._findAncestors(c);-1===f.indexOf(e)&&(c.parent=e,c.$row.attr(b.parent,e))}})},_sort:function(){},_reflowTable:function(){var a=this;(this.options.forceTreeConstraints||this._treeColumn())&&(this._treeWalk(this._tree,function(b){b.$row.detach(),a.element.append(b.$row)}),this._shiftErrorsToEnd())},_redecorate:function(){var b=this,c=this,d=this.options.indent,e=this._treeColumn(),f=this._tree.children[0].$row.children("td.jtt-tree-node").index();if(c.options.console.debug&&console.log("currentTNode is "+f+" treeCol (with offset) is "+(e-2)),f>=0&&f!==e-2){var g=this.element.find(".jtt-tree-node");g.find(".jtt-node-offset").remove(),g.find(".jtt-entry").contents().unwrap(),g.removeClass("jtt-tree-node")}0!==e&&this._treeWalk(this._tree,function(c,f){var g=c.$row.children("td.jtt-tree-node"),h=g.find("div.jtt-node-offset");if(0===g.length&&(h=a('<div class="jtt-node-offset" style="margin-left: '+f*d+'px"><div class="jtt-connector"></div></div>'),g=c.$row.children("td:nth-of-type("+(e-1)+")").addClass("jtt-tree-node").wrapInner('<div class="jtt-entry"></div>').prepend(h)),c.children.length?b._appendControlTo(c,h):c.$row.find("a.jtt-control").remove(),b.options.showLines&&c.parent&&"/"!==c.parent){var i=c.$row.prevAll('tr[data-jtt-parent="'+c.parent+'"]').first();0===i.length&&(i=c.$row.prev('tr[data-jtt-id="'+c.parent+'"]'));var j=i.find("div.jtt-connector"),k=j.offset().top,l=g.offset().top+g.find("div.jtt-node-offset").height()/2-(k+j.outerHeight(!1)-1);c.$row.find("div.jtt-connector").addClass("jtt-show-lines").css("height",l+"px").css("margin-top","-"+l+"px")}else c.$row.find("div.jtt-connector").removeClass("jtt-show-lines")})},_toggleAttr:function(a,b){var c=b||!this.element.attr(a);c?this.element.attr(a,""):this.element.removeAttr(a)},_appendControlTo:function(b,c){var d=this,e=c.find(".jtt-control");0===e.length&&(e=a('<a link="#" class="jtt-control"><span></span></a>'),e.on("click",function(c){var e=b;d._toggleNode(e),a(c.currentTarget).find("span").first().removeClass(b.open?d.options.nodeClosedGlyph:d.options.nodeOpenGlyph).addClass(b.open?d.options.nodeOpenGlyph:d.options.nodeClosedGlyph)}).find("span").first().addClass(b.open?d.options.nodeOpenGlyph:d.options.nodeClosedGlyph),c.append(e))},_active:function(a){var c=this;this._toggleAttr(b.active,a),c.options.active=a,a?(void 0===c._observers.tbody&&(c._observers.tbody=new MutationObserver(function(a){c._update()})),void 0===c._observers.thead&&(c._observers.thead=new MutationObserver(function(a){c._update()})),c.element.find("thead td, thead th").each(function(){c._observers.thead.observe(this,{attributes:!0})}),c._bodyObserverState(!0)):(c._bodyObserverState(!1),void 0!==c._observers.thead&&c._observers.thead.disconnect())},_bodyObserverState:function(a){void 0!==this._observers.tbody&&(a?(this._observers.tbody.observe(this.element.find("tbody").get()[0],{childList:!0,subtree:!0,attributes:!0}),this.options.console.debug&&console.log("OBSERVER ON")):(this._observers.tbody.disconnect(),this.options.console.debug&&console.log("OBSERVER OFF")))},_shiftErrorsToEnd:function(){var b=a(".jtt-error");b.remove().appendTo(this.element)},_treeColumn:function(){return this._columnSettings.findIndex(function(a){return a&&void 0!==a.tree})+1},_fixupParents:function(){this.element.find("tbody tr["+b.fixedParent+"]").attr(b.parent,function(){return this.getAttribute(b.fixedParent)})},_findAncestors:function(a){for(var b=[],c=a;void 0!==c.parent;)b.push(c.parent),c=c.parent;return b},_uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},_treeWalk:function(a,b){var c=arguments.length<=2||void 0===arguments[2]?0:arguments[2],d=!0;if(a.$row&&(d=b(a,c),d=void 0!==d&&"boolean"==typeof d?d:!0),d)for(var e=a.children.length,f=0;e>f;f++)this._treeWalk(a.children[f],b,c+1)},_toggleNode:function(a){var b=a.children.length;a.open=!a.open;for(var c=0;b>c;c++)this._treeWalk(a.children[c],function(b){return b.open?void b.$row.toggle(a.open):!1});this._redecorate()}})}(jQuery);